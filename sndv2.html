<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Microphone Array Data Visualizer</title>
    <style>
        body {
            margin: 0;
            background: black;
            color: white;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .controls {
            height: 10%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: #222;
        }
        .controls button, .controls select {
            padding: 6px 12px;
            margin-right: 10px;
            background: #444;
            color: white;
            border: none;
            cursor: pointer;
        }
        .main-content {
            display: flex;
            flex: 1;
        }
        .table-container {
            width: 50%;
            height: 100%;
            overflow-y: auto;
            background: #111;
            padding: 10px;
        }
        details summary {
            cursor: pointer;
            padding: 4px 0;
        }
        .visualizer-container {
            width: 50%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            border: 1px solid white;
            width: 90%;
            height: 90%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div>
                <button onclick="startStream()">Start</button>
                <button onclick="pauseStream()">Pause</button>
                <button onclick="stopStream()">Stop</button>
                <button onclick="downloadData()">Download</button>
            </div>
            <div>
                <label for="vizSelect">Visualization:</label>
                <select id="vizSelect" onchange="changeViz(this.value)">
                    <option value="1">VIZ1</option>
                    <option value="2">VIZ2</option>
                    <option value="3">VIZ3</option>
                    <option value="4">VIZ4</option>
                    <option value="5">VIZ5</option>
                    <option value="6">VIZ6</option>
                    <option value="7">VIZ7</option>
                    <option value="8">VIZ8</option>
                    <option value="9">VIZ9</option>
                    <option value="10">VIZ10</option>
                </select>
            </div>
        </div>
        <div class="main-content">
            <div class="table-container" id="madTable"></div>
            <div class="visualizer-container">
                <canvas id="micVisualizer"></canvas>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('micVisualizer');
        const ctx = canvas.getContext('2d');
        const vizSelect = document.getElementById('vizSelect');
        const madTable = document.getElementById('madTable');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        let streamSource;
        let currentViz = 1;
        let animFrame;

        const MAD = {};

        async function startStream() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            streamSource = audioCtx.createMediaStreamSource(stream);
            streamSource.connect(analyser);
            draw();
            updateMAD();
        }

        function pauseStream() {
            cancelAnimationFrame(animFrame);
            clearInterval(madInterval);
        }

        function stopStream() {
            pauseStream();
            if (streamSource) streamSource.disconnect();
        }

        function downloadData() {
            const blob = new Blob([JSON.stringify(MAD, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'mad_data.json';
            a.click();
        }

        function changeViz(v) {
            currentViz = parseInt(v);
        }

        function draw() {
            animFrame = requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const vizFunctions = [null, drawVIZ1, drawVIZ2, drawVIZ3, drawVIZ4, drawVIZ5, drawVIZ6, drawVIZ7, drawVIZ8, drawVIZ9, drawVIZ10];
            vizFunctions[currentViz]?.();
        }

        let madInterval;
        function updateMAD() {
            madInterval = setInterval(() => {
                analyser.getByteFrequencyData(dataArray);
                const now = new Date();
                const [d, h, m] = [now.toISOString().slice(0, 10), now.getHours(), now.getMinutes()];
                const second = now.getSeconds();
                const bands = 10;
                const bandData = Array.from({ length: bands }, (_, i) => {
                    const start = Math.floor(i * bufferLength / bands);
                    const end = Math.floor((i + 1) * bufferLength / bands);
                    const slice = dataArray.slice(start, end);
                    const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
                    return Math.round(avg);
                });
                MAD[d] = MAD[d] || {};
                MAD[d][h] = MAD[d][h] || {};
                MAD[d][h][m] = MAD[d][h][m] || {};
                MAD[d][h][m][second] = bandData;
                renderTable();
            }, 1000);
        }

        function renderTable() {
            madTable.innerHTML = '';
            for (const day in MAD) {
                const dayEl = document.createElement('details');
                const daySum = document.createElement('summary');
                daySum.textContent = `Date: ${day}`;
                dayEl.appendChild(daySum);

                for (const hour in MAD[day]) {
                    const hourEl = document.createElement('details');
                    const hourSum = document.createElement('summary');
                    hourSum.textContent = `Hour: ${hour}`;
                    hourEl.appendChild(hourSum);

                    for (const minute in MAD[day][hour]) {
                        const minEl = document.createElement('details');
                        const minSum = document.createElement('summary');
                        minSum.textContent = `Minute: ${minute}`;
                        minEl.appendChild(minSum);

                        for (const sec in MAD[day][hour][minute]) {
                            const secP = document.createElement('p');
                            secP.textContent = `Second: ${sec} → [${MAD[day][hour][minute][sec].join(', ')}]`;
                            minEl.appendChild(secP);
                        }
                        hourEl.appendChild(minEl);
                    }
                    dayEl.appendChild(hourEl);
                }
                madTable.appendChild(dayEl);
            }
        }

        // VIZ1–VIZ10 definitions here (unchanged from prior version)
        // You can reinsert the previous drawVIZ1 to drawVIZ10 functions here
    </script>
</body>
</html>
