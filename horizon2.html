<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAD Horizons v2.0 - Full</title>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: Arial, sans-serif; overflow-y: scroll; }
    .controls { background: #111; padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; position: sticky; top: 0; z-index: 10; }
    button { background: #333; color: white; border: none; padding: 8px 16px; cursor: pointer; }
    canvas { width: 100%; height: 300px; background: black; }
    .panel { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <button onclick="clearAll()">Clear</button>
    <button onclick="download()">Download</button>
  </div>

  <div id="panels"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script>
let audioCtx, analyser, streamSource, dataArray, micStream;
let charts = [];
let fullData = [];

function makePanel(id) {
  const container = document.createElement('div');
  container.className = 'panel';
  const canvas = document.createElement('canvas');
  canvas.id = 'c' + id;
  container.appendChild(canvas);
  document.getElementById('panels').appendChild(container);

  const ctx = canvas.getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [...Array(10)].map((_, i) => ({
        label: 'CH' + (i + 1),
        data: [],
        backgroundColor: 'hsl(' + (i * 36) + ',100%,50%)',
        stack: 'stack1'
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
      plugins: {
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
        }
      }
    }
  });

  charts.push(chart);
}

for (let i = 0; i < 10; i++) makePanel(i);

function start() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    dataArray = new Uint8Array(analyser.frequencyBinCount);

    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        micStream = stream;
        streamSource = audioCtx.createMediaStreamSource(stream);
        streamSource.connect(analyser);
        setInterval(capture, 1000);
      })
      .catch(err => alert('Mic access denied: ' + err.message));
  }
}

function stop() {
  if (micStream) {
    micStream.getTracks().forEach(track => track.stop());
    micStream = null;
    audioCtx = null;
    streamSource = null;
  }
}

function capture() {
  if (!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  const bands = 10;
  const points = Array.from({ length: bands }, (_, i) => {
    const start = Math.floor(i * dataArray.length / bands);
    const end = Math.floor((i + 1) * dataArray.length / bands);
    const slice = dataArray.slice(start, end);
    return Math.round(slice.reduce((a, b) => a + b, 0) / slice.length);
  });
  const now = new Date().toLocaleTimeString();
  fullData.push({ timestamp: now, channels: points });

  charts.forEach(chart => {
    if (chart.data.labels.length >= 60) {
      chart.data.labels.shift();
      chart.data.datasets.forEach(d => d.data.shift());
    }
    chart.data.labels.push(now);
    chart.data.datasets.forEach((d, idx) => d.data.push(points[idx]));
    chart.update();
  });
}

function clearAll() {
  charts.forEach(chart => {
    chart.data.labels = [];
    chart.data.datasets.forEach(d => d.data = []);
    chart.update();
  });
  fullData = [];
}

function download() {
  const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mad_horizons_data.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
  </script>
</body>
</html>
