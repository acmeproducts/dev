<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAD Horizons v2.2</title>
  <style>
    body { margin: 0; background: #000; font-family: sans-serif; color: #fff; overflow: hidden; }
    .config-panel {
      position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: #111;
      transform: translateX(-100%); transition: transform 0.3s ease; padding: 10px; box-sizing: border-box;
      overflow-y: auto; z-index: 1000;
    }
    .config-panel.open { transform: translateX(0); }
    .config-toggle {
      position: fixed; top: 10px; left: 10px; z-index: 1100; background: #222; border: none;
      color: white; padding: 6px 10px; cursor: pointer;
    }
    .control-label { display: block; margin-top: 10px; font-size: 14px; }
    .control-group { margin-bottom: 10px; }
    .main-content { margin-left: 0; height: 100vh; overflow-y: scroll; margin-top: 44px; }
    .panel { height: 280px; padding: 4px; }
    canvas { width: 100%; height: 100%; background: black; }
    .top-bar {
      position: fixed; top: 0; left: 0; width: 100%; height: 44px; background: #111;
      display: flex; justify-content: center; align-items: center; gap: 10px; z-index: 500;
    }
    .top-bar button {
      background: #333; color: white; border: none; padding: 6px 14px; cursor: pointer;
    }
  </style>
</head>
<body>

  <button class="config-toggle" onclick="togglePanel()">â˜°</button>

  <div class="config-panel" id="configPanel">
    <h3>Configuration</h3>
    <div class="control-group">
      <label class="control-label">Background Color</label>
      <input type="color" id="bgColor" value="#000000" onchange="applySettings()" />
    </div>
    <div class="control-group">
      <label class="control-label"># Panels</label>
      <input type="number" id="panelCount" min="1" max="10" value="10" onchange="buildPanels()" />
    </div>
    <div class="control-group">
      <label class="control-label">Sampling Interval (ms)</label>
      <input type="number" id="interval" min="100" step="100" value="1000" />
    </div>
    <div class="control-group">
      <label><input type="checkbox" id="showTitles" checked onchange="applySettings()"> Show Titles</label>
    </div>
    <div class="control-group">
      <button onclick="saveConfig()">Save Config</button>
      <button onclick="loadConfig()">Load Config</button>
    </div>
  </div>

  <div class="top-bar">
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <button onclick="clearAll()">Clear</button>
    <button onclick="download()">Download</button>
  </div>

  <div class="main-content" id="panelArea"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script>
let audioCtx, analyser, streamSource, micStream, dataArray;
let charts = [], fullData = [], captureInterval;

function togglePanel() {
  document.getElementById("configPanel").classList.toggle("open");
}

function buildPanels() {
  stop();
  clearAll();
  const count = parseInt(document.getElementById("panelCount").value);
  const panelArea = document.getElementById("panelArea");
  panelArea.innerHTML = '';
  charts = [];

  for (let i = 0; i < count; i++) {
    const div = document.createElement("div");
    div.className = "panel";
    const canvas = document.createElement("canvas");
    canvas.id = 'chart' + i;
    if (document.getElementById("showTitles").checked) {
      const label = document.createElement("div");
      label.innerText = `Panel ${i + 1}`;
      label.style.padding = "4px";
      label.style.color = "#0f0";
      div.appendChild(label);
    }
    div.appendChild(canvas);
    panelArea.appendChild(div);

    const ctx = canvas.getContext("2d");
    const datasets = Array.from({ length: 10 }, (_, ch) => ({
      label: 'CH' + (ch + 1),
      data: [],
      backgroundColor: 'hsl(' + (ch * 36) + ',100%,50%)',
      stack: 'stack1'
    }));

    charts.push(new Chart(ctx, {
      type: 'bar',
      data: { labels: [], datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true },
          y: { stacked: true, beginAtZero: true }
        },
        plugins: {
          zoom: {
            pan: { enabled: true, mode: 'x' },
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
          }
        }
      }
    }));
  }

  applySettings();
}

function applySettings() {
  document.body.style.backgroundColor = document.getElementById("bgColor").value;
  document.getElementById("panelArea").style.backgroundColor = document.getElementById("bgColor").value;
}

function saveConfig() {
  const config = {
    bgColor: document.getElementById("bgColor").value,
    panelCount: document.getElementById("panelCount").value,
    interval: document.getElementById("interval").value,
    showTitles: document.getElementById("showTitles").checked
  };
  localStorage.setItem("madHorizonsConfig", JSON.stringify(config));
  alert("Config saved.");
}

function loadConfig() {
  const config = JSON.parse(localStorage.getItem("madHorizonsConfig"));
  if (config) {
    document.getElementById("bgColor").value = config.bgColor;
    document.getElementById("panelCount").value = config.panelCount;
    document.getElementById("interval").value = config.interval;
    document.getElementById("showTitles").checked = config.showTitles;
    buildPanels();
    applySettings();
    alert("Config loaded.");
  } else {
    alert("No saved config.");
  }
}

function start() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }

  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    micStream = stream;
    streamSource = audioCtx.createMediaStreamSource(stream);
    streamSource.connect(analyser);
    const interval = parseInt(document.getElementById("interval").value);
    captureInterval = setInterval(capture, interval);
  }).catch(err => alert("Mic access denied: " + err.message));
}

function stop() {
  clearInterval(captureInterval);
  if (micStream) {
    micStream.getTracks().forEach(t => t.stop());
    micStream = null;
    streamSource = null;
    audioCtx = null;
  }
}

function capture() {
  analyser.getByteFrequencyData(dataArray);
  const bands = 10;
  const points = Array.from({ length: bands }, (_, i) => {
    const start = Math.floor(i * dataArray.length / bands);
    const end = Math.floor((i + 1) * dataArray.length / bands);
    const slice = dataArray.slice(start, end);
    return Math.round(slice.reduce((a, b) => a + b, 0) / slice.length);
  });
  const now = new Date().toLocaleTimeString();
  fullData.push({ timestamp: now, channels: points });

  charts.forEach(chart => {
    if (chart.data.labels.length >= 60) {
      chart.data.labels.shift();
      chart.data.datasets.forEach(ds => ds.data.shift());
    }
    chart.data.labels.push(now);
    chart.data.datasets.forEach((d, i) => d.data.push(points[i]));
    chart.update();
  });
}

function clearAll() {
  charts.forEach(chart => {
    chart.data.labels = [];
    chart.data.datasets.forEach(d => d.data = []);
    chart.update();
  });
  fullData = [];
}

function download() {
  const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'mad_horizons_data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

window.onload = buildPanels;
  </script>
</body>
</html>
